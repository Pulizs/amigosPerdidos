<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil de Emergência</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
</head>
<body class="bg-slate-50 min-h-screen p-4 pb-12 font-sans">

    <div id="conteudo-perfil" class="max-w-md mx-auto space-y-6">
        <div class="flex flex-col items-center justify-center py-20 text-slate-400 italic text-xs uppercase tracking-widest font-bold text-center">
            <i class="ph ph-circle-notch animate-spin text-3xl mb-4 text-red-500"></i>
            Conectando ao SOS Cloud...
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, getDoc, getDocs, doc, collection } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCffiFbyNzZz7M9bbNVg6XQaEht-QWHuXU",
            authDomain: "sos-pulseiras.firebaseapp.com",
            projectId: "sos-pulseiras",
            storageBucket: "sos-pulseiras.firebasestorage.app",
            messagingSenderId: "940338535189",
            appId: "1:940338535189:web:6f039855d2f96258cca71c",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        async function carregarDados() {
            const container = document.getElementById('conteudo-perfil');
            const params = new URLSearchParams(window.location.search);
            const idDono = params.get('id');

            if (!idDono) return;

            try {
                const donoSnap = await getDoc(doc(db, "amigos", idDono));
                const todosSnap = await getDocs(collection(db, "amigos"));

                if (donoSnap.exists()) {
                    const dono = donoSnap.data();
                    let outrosHTML = "";
                    const msgDono = encodeURIComponent(`Olá, estou com o seu amigo ${dono.nome}. Encontrei este contato pela pulseira de emergência.`);

                    todosSnap.forEach(s => {
                        if (s.id !== idDono) {
                            const a = s.data();
                            const msgOutro = encodeURIComponent(`Olá, estou com o seu amigo ${dono.nome}. Vi seu contato no perfil de emergência dele.`);
                            const telLimpo = a.tel.replace(/\D/g, '');
                            outrosHTML += `
                                <div class="bg-white p-4 rounded-2xl border border-slate-100 flex items-center justify-between shadow-sm">
                                    <p class="font-bold text-slate-700 text-sm uppercase">${a.nome.split(' ')[0]}</p>
                                    <a href="https://wa.me/${telLimpo}?text=${msgOutro}" target="_blank" class="text-green-600 bg-green-50 w-10 h-10 flex items-center justify-center rounded-xl">
                                        <i class="ph ph-whatsapp-logo text-xl"></i>
                                    </a>
                                </div>`;
                        }
                    });

                    const telDonoLimpo = dono.tel.replace(/\D/g, '');
                    container.innerHTML = `
                        <div class="bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border border-slate-100">
                            <div class="bg-red-600 p-8 text-center text-white shadow-inner">
                                <div class="bg-white/20 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 backdrop-blur-sm">
                                    <i class="ph ph-first-aid text-3xl font-bold"></i>
                                </div>
                                <h1 class="text-2xl font-black uppercase tracking-tight">${dono.nome}</h1>
                                <span class="inline-block mt-2 px-4 py-1 bg-white text-red-600 rounded-full font-black text-sm uppercase italic tracking-widest shadow-sm">Sangue ${dono.sangue || '??'}</span>
                            </div>

                            <div class="p-8 space-y-6">
                                <div class="bg-amber-50 border border-amber-100 p-5 rounded-2xl">
                                    <h3 class="text-[10px] font-black text-amber-600 uppercase tracking-widest mb-1 italic">Informações Médicas</h3>
                                    <p class="text-slate-700 font-bold leading-relaxed">${dono.alergias || 'Nenhuma alergia ou nota informada.'}</p>
                                </div>

                                <a href="https://wa.me/${telDonoLimpo}?text=${msgDono}" target="_blank" class="flex items-center justify-between bg-green-600 text-white p-5 rounded-3xl shadow-lg shadow-green-100 active:scale-95 transition-all">
                                    <div class="flex items-center gap-4 text-left">
                                        <i class="ph ph-whatsapp-logo text-3xl"></i>
                                        <div>
                                            <p class="text-[10px] opacity-80 font-bold uppercase tracking-widest">Aviso Prioritário</p>
                                            <p class="text-lg font-black leading-tight">WHATSAPP RESPONSÁVEL</p>
                                        </div>
                                    </div>
                                    <i class="ph ph-caret-right text-xl opacity-50"></i>
                                </a>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <h3 class="text-slate-400 text-[10px] font-black uppercase tracking-[0.2em] ml-5">Outros Contatos do Grupo</h3>
                            ${outrosHTML || '<p class="text-center text-xs text-slate-300">Nenhum outro contato.</p>'}
                        </div>`;
                }
            } catch (err) { console.error("Erro no Firebase:", err); }
        }
        carregarDados();
    </script>
</body>
</html>