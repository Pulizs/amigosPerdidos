<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SOS Pulseiras - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  </head>
  <body class="bg-slate-50 min-h-screen p-4 md:p-10 font-sans text-slate-900">
    <div class="max-w-5xl mx-auto">
      <header class="mb-10 flex items-center gap-4">
        <div class="bg-red-600 p-3 rounded-2xl shadow-lg">
          <i class="ph ph-shield-check text-white text-3xl"></i>
        </div>
        <div>
          <h1 class="text-2xl font-black uppercase tracking-tight">
            SOS System
          </h1>
          <p class="text-slate-500 text-sm font-medium italic">
            Powered by Firebase
          </p>
        </div>
      </header>

      <div class="grid lg:grid-cols-3 gap-8">
        <section
          class="lg:col-span-1 bg-white p-6 rounded-3xl shadow-sm border border-slate-100 h-fit"
        >
          <h2 class="text-lg font-bold mb-6 flex items-center gap-2">
            <i class="ph ph-plus-circle text-blue-500"></i> Novo Cadastro
          </h2>
          <form id="form-amigo" class="space-y-4">
            <input
              type="text"
              id="nome"
              class="w-full p-3 bg-slate-50 rounded-xl"
              placeholder="Nome do Amigo"
              required
            />
            <div class="grid grid-cols-2 gap-3">
              <input
                type="text"
                id="sangue"
                class="w-full p-3 bg-slate-50 rounded-xl"
                placeholder="Sangue"
              />
              <input
                type="tel"
                id="telefone"
                class="w-full p-3 bg-slate-50 rounded-xl"
                placeholder="Tel: 119..."
                required
              />
            </div>
            <textarea
              id="alergias"
              class="w-full p-3 bg-slate-50 rounded-xl h-24"
              placeholder="Alergias importantes..."
            ></textarea>
            <button
              type="submit"
              class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold hover:bg-slate-800 transition-all shadow-lg active:scale-95"
            >
              Salvar Amigo
            </button>
          </form>
        </section>

        <section class="lg:col-span-2 space-y-4">
          <h2 class="text-lg font-bold flex items-center gap-2 text-slate-700">
            <i class="ph ph-users text-green-500"></i> Integrantes do Grupo
          </h2>
          <div id="lista-amigos" class="grid sm:grid-cols-2 gap-4"></div>
        </section>
      </div>
    </div>

    <div
      id="modal-qr"
      class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-50"
    >
      <div
        class="bg-white p-8 rounded-[2.5rem] text-center shadow-2xl max-w-sm w-full"
      >
        <h3
          id="qr-nome"
          class="font-black text-xl mb-6 text-slate-800 uppercase"
        ></h3>
        <div
          id="qrcode"
          class="flex justify-center p-4 bg-white rounded-2xl mb-6 border border-slate-100"
        ></div>
        <button
          onclick="fecharModal()"
          class="w-full py-4 bg-slate-100 text-slate-500 rounded-2xl font-bold hover:bg-red-50 hover:text-red-500 transition-all"
        >
          Fechar
        </button>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        onSnapshot,
        doc,
        deleteDoc,
      } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

      // CONFIGURAÇÃO DO SEU FIREBASE (Substitua pelos seus dados do console)
      const firebaseConfig = {
        apiKey: "AIzaSyCffiFbyNzZz7M9bbNVg6XQaEht-QWHuXU",
        authDomain: "http://sos-pulseiras.firebaseapp.com",
        projectId: "sos-pulseiras",
        storageBucket: "http://sos-pulseiras.firebasestorage.app",
        messagingSenderId: "940338535189",
        appId: "1:940338535189:web:6f039855d2f96258cca71c",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const amigosCol = collection(db, "amigos");

      // SALVAR NO FIREBASE
      document
        .getElementById("form-amigo")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          try {
            await addDoc(amigosCol, {
              nome: document.getElementById("nome").value,
              sangue: document.getElementById("sangue").value,
              tel: document.getElementById("telefone").value,
              alergias: document.getElementById("alergias").value,
            });
            document.getElementById("form-amigo").reset();
          } catch (err) {
            alert("Erro ao salvar: " + err);
          }
        });

      // LISTAR EM TEMPO REAL
      onSnapshot(amigosCol, (snapshot) => {
        const container = document.getElementById("lista-amigos");
        container.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const amigo = docSnap.data();
          const id = docSnap.id;
          const card = document.createElement("div");
          card.className =
            "bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-between";
          card.innerHTML = `
                    <div class="mb-4">
                        <p class="font-black text-slate-800 text-lg uppercase leading-tight">${amigo.nome}</p>
                        <span class="text-[10px] font-bold text-red-500 uppercase tracking-widest">Sangue ${amigo.sangue || "--"}</span>
                    </div>
                    <div class="flex gap-2 border-t pt-4 border-slate-50">
                        <button onclick="gerarQR('${id}', '${amigo.nome}')" class="flex-grow flex items-center justify-center gap-2 p-3 bg-blue-50 text-blue-600 rounded-xl font-bold">
                            <i class="ph ph-qr-code text-xl"></i> QR CODE
                        </button>
                        <button onclick="removerAmigo('${id}')" class="p-3 bg-slate-50 text-slate-400 rounded-xl hover:text-red-500 transition">
                            <i class="ph ph-trash"></i>
                        </button>
                    </div>
                `;
          container.appendChild(card);
        });
      });

      // EXPOR FUNÇÕES PARA O HTML (ESSENCIAL PARA FUNCIONAR O ONCLICK)
      window.gerarQR = (id, nome) => {
        const qrContainer = document.getElementById("qrcode");
        qrContainer.innerHTML = "";
        document.getElementById("qr-nome").innerText = nome;

        // Define o link correto para o GitHub Pages
        const url =
          window.location.origin +
          window.location.pathname.replace("index.html", "") +
          `subpages/perfil.html?id=${id}`;

        new QRCode(qrContainer, { text: url, width: 200, height: 200 });
        document.getElementById("modal-qr").classList.remove("hidden");
      };

      window.removerAmigo = async (id) => {
        if (confirm("Deseja excluir este registro?"))
          await deleteDoc(doc(db, "amigos", id));
      };

      window.fecharModal = () =>
        document.getElementById("modal-qr").classList.add("hidden");
    </script>
  </body>
</html>
